# Daily Notes - 2026-01-31

## Cairo Compiler Issues & Resolution

### Problem
- Scarb 2.8.1 had broken storage trait generation
- Error: `Method 'write' not found on type 'StorageBase::<Mutable::<felt252>>'`

### Solution
- Downloaded Scarb 2.15.1 from GitHub releases
- Installed to `~/.local/bin/scarb-new`
- Fixed Cairo contract with proper imports:
  - `StoragePointerReadAccess`, `StoragePointerWriteAccess`
  - `StorageMapReadAccess`, `StorageMapWriteAccess`
  - `Map` for dictionary storage

### Result
```
$ ~/.local/bin/scarb-new build
    Finished `dev` profile target(s) in 1 second
```

Generated: `target/dev/starknet_shielded_pool.sierra.json`

## Starknet Privacy Skill Development

### Files Created
- `contracts/starknet_shielded_pool/src/lib.cairo` - Cairo contract
- `contracts/starknet_shielded_pool/Scarb.toml` - Project config
- `scripts/zk_circuit.py` - Mock ZK-SNARK circuit
- `scripts/garaga_demo.py` - Garaga integration demo
- `ZK_SNARK_INTEGRATION.md` - Full integration guide
- `README.md` - Project overview
- `COMPILE_STATUS.md` - Compiler status

### Cairo Contract Functions
| Function | Description |
|----------|-------------|
| `deposit(commitment)` | Deposit, create note |
| `transfer(nullifier, old, new, data)` | Private transfer |
| `withdraw(nullifier, commitment, amount, recipient)` | Withdraw |
| `is_nullifier_spent(nullifier)` | Check double-spend |
| `get_pool_balance()` | Get balance |
| `get_merkle_root()` | Get merkle root |
| `update_merkle_root(new_root)` | Update root (owner) |
| `get_note(commitment)` | Get note data |

### Python ZK-SNARK Demo
- Created mock ZK circuit demonstrating:
  - Pedersen commitment generation
  - Nullifier computation
  - Merkle proof verification
  - Balance preservation constraints

### Garaga Installation
- Installed Garaga 0.18.2 via uv
- Available modules:
  - `groth16_contract_generator` - Generate verifier contracts
  - `honk_contract_generator` - Honk verifier
- Partial prover support (needs full setup)

## Commands Used

```bash
# Cairo compilation
~/.local/bin/scarb-new build

# Python demos
python3.12 scripts/cli.py demo
python3.12 scripts/zk_circuit.py

# Garaga
uv pip install garaga
```

## Sierra v1 Compilation Issue (2026-01-31 22:24)

### Problem
Wallet requires both Sierra + CASM files, but modern Scarb (Cairo 2.x) only outputs Sierra v1 format.

```
# Old cairo-lang compiler expects legacy Sierra format
compile_sierra_to_casm() error:
"missing field `sierra_program`"
```

### Root Cause
- Scarb 2.15.1 generates Sierra v1 (modern Cairo 2.x format)
- Old `starknet-py 0.26.2` / `cairo-lang 0.14.0.1` expects legacy Sierra format
- 2026 wallets should accept Sierra-only (on-chain compilation), but some still need CASM

### Files Generated
```
contracts/starknet_shielded_pool/target/dev/starknet_shielded_pool.sierra.json (513KB)
```

### Attempted Solutions
1. âœ… `cairo-lang` v1 compiler - expects legacy format
2. âŒ `compile_sierra_to_casm()` - fails on Sierra v1
3. â³ Modern wallets (2025+) - should accept Sierra-only

### Next Steps
1. Update wallet to 2026 version (Braavos/Argent X)
2. Or find modern Sierraâ†’CASM converter
3. Deploy using only Sierra file (if wallet supports)

## Memory Updated: 2026-01-31 22:30
- âœ… Starknet shielded pool compiled successfully
- âš ï¸ CASM generation blocked (legacy compiler)
- ðŸ’¡ Sierra v1 ready - wallet needs update

## Next Steps
1. Deploy Cairo contract to Starknet Sepolia (after wallet update)
2. Complete Garaga ZK proof generation
3. Generate on-chain verifier contract

## Garaga Integration (Later)

### Demo Runs
- `scripts/garaga_integration.py` - Full shielded pool demo
- `scripts/zk_circuit.py` - Mock ZK circuit demo

### Shielded Transfer Flow
```
1. Create note: value=0.1 ETH, secret=..., salt=...
2. Generate commitment: H(value || secret || salt)
3. Generate nullifier: H(secret || salt)
4. Transfer: amount=0.05 ETH, change=0.05 ETH
5. New commitment: H(change || secret || new_salt)
```

### Garaga Modules Status (2026-01-31 20:33)
| Module | Status | Notes |
|--------|--------|-------|
| algebra | âœ… | BaseField, Fp2 available |
| groth16_contract_generator | âš ï¸ | Available but import issue |
| honk_contract_generator | âš ï¸ | Available but import issue |
| precompiled_circuits | âŒ | Not loading |
| FieldElement | âŒ | Different API |

### Notes
- felt252 doesn't support comparisons (`>=`, `<=`)
- Map storage needs `StorageMapReadAccess`/`StorageMapWriteAccess`
- Cairo 2.15.0 + starknet 2.15.0 dependencies
- Garaga 0.18.2 installed, some modules have import issues
- Mock ZK proofs work, real proofs need trusted setup
